<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Pro Studio Thumbnail Creator – Free with Ads</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;400&display=swap" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <!-- Google AdSense: Replace publisher ID and slot IDs with your own! -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" crossorigin="anonymous"></script>
<style>
  html, body { height: 100%; margin: 0; padding: 0; box-sizing: border-box;}
  body {
    font-family: "Montserrat", Arial, sans-serif;
    background: linear-gradient(129deg, #21243a 0%, #23a4dd 75%, #dbfff2 100%);
    color: #222;
    user-select: none;
    overflow: auto;
    min-height: 100vh;
    transition: background 0.3s;
  }
  body.darktheme {
    background: linear-gradient(129deg, #12131c 0%, #0a374d 75%, #162f40 100%);
    color: #ddd;
  }
  #topAdContainer {
    width: 100%;
    text-align: center;
    margin-bottom: 10px;
    background: #f2fdff;
    box-shadow: 0 2px 12px #19bef622;
    position: sticky;
    top: 0;
    z-index: 2001;
  }
  #bottomAdContainer {
    width: 100%;
    position: fixed;
    left: 0;
    bottom: 0;
    z-index: 2000;
    background: #fff;
    box-shadow: 0 -3px 18px #b4e3eb44;
    text-align: center;
    padding: 6px 0;
    display: none;
  }
  #appbar {
    height: 60px; background: rgba(36, 42, 67, 0.97);
    color: #fff; display: flex; align-items: center;
    font-weight: 700; font-size: 1.19em; letter-spacing: 1.1px;
    padding: 0 25px; box-shadow: 0 4px 20px 0 #18214424;
    z-index: 999; justify-content: space-between; position: sticky; top: 0;
    width: 100vw;
  }
  #appbar .logo {
    font-weight: 900; font-size: 1.35em;
    letter-spacing: 1.3px; color: #6cf8e8; user-select: text;
  }
  #appbar nav {
    display: flex; gap: 15px;
  }
  #appbar nav button {
    background: linear-gradient(98deg, #65f7fa 40%, #37e2b3 120%);
    color: #114a83;
    padding: 8px 11px;
    border: none;
    border-radius: 8px;
    font-size: .99em;
    font-weight: 700;
    box-shadow: 0 1.5px 6px #62eae911;
    transition: background .12s;
    cursor: pointer;
    gap: 7px;
    display: flex;
    align-items: center;
  }
  #appbar nav button:disabled {
    opacity: .6;
    cursor: not-allowed;
    background: #499ca4;
  }
  #appbar nav button:hover {
    background: #243cc7;
    color: #fff;
  }
  #studio-shell {
    display: flex;
    max-width: 1440px;
    margin: 80px auto 40px auto;
    border-radius: 20px;
    box-shadow: 0 13px 36px #283c9399;
    background: rgba(245, 252, 255, 0.97);
    min-height: 650px;
    overflow: auto;
    height: calc(100vh - 110px);
  }
  #sidebar {
    width: 92px;
    min-width: 68px;
    background: rgba(15, 23, 65, 0.93);
    border-radius: 22px 0 0 22px;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px 0 10px 0;
    gap: 8px;
    box-shadow: 4px 0 32px #4ae7ef37;
    z-index: 20;
    left: 0;
    top: 60px;
    height: 100vh;
    position: sticky;
  }
  .sidebtn {
    width: 53px;
    height: 53px;
    border: none;
    border-radius: 13px;
    cursor: pointer;
    background: linear-gradient(135deg, #1be9cecc 30%, #2b69b3dd 88%);
    box-shadow: 0 2px 14px #50e6e622;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5em;
    color: #fff;
    margin-bottom: 7px;
    transition: background 0.13s, box-shadow 0.13s;
  }
  .sidebtn.selected,
  .sidebtn:focus,
  .sidebtn:hover {
    background: #fffaf2;
    color: #13dabb;
    box-shadow: 0 2px 16px #4abce6;
  }
  .tool-tip {
    display: none;
    position: absolute;
    top: 70%;
    left: 110%;
    background: #333b42;
    color: #fff;
    text-align: left;
    font-size: 0.98em;
    padding: 6px 15px;
    border-radius: 5px;
    pointer-events: none;
    box-shadow: 0 2px 8px #173e6518;
    white-space: nowrap;
    user-select: none;
    z-index: 99;
  }
  .sidebtn:focus .tool-tip,
  .sidebtn:hover .tool-tip {
    display: block;
  }
  #middle-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    background: none;
    min-width: 300px;
    max-width: 100vw;
    padding: 0 12px;
  }
  #canvasbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(255, 255, 255, 0.77);
    backdrop-filter: blur(6px);
    margin: 10px 0 6px 0;
    border-radius: 13px;
    padding: 8px 12px;
    box-shadow: 0 2px 11px #1c49f426;
    width: 100%;
    max-width: 960px;
    box-sizing: border-box;
  }
  #canvasbar .title {
    font-size: 1.15em;
    color: #174484;
    font-weight: 700;
  }
  #main-canvas {
    background: #fff;
    border-radius: 17px 17px 19px 19px;
    box-shadow: 0 4px 26px #15bbf322, 0 0px 6px #b0e9ecd2;
    border: 2.5px solid #23a4dd;
    cursor: grab;
    margin: 12px auto 12px auto;
    max-width: 97vw;
    max-height: 69vh;
    user-select: none;
    touch-action: none;
    transition: box-shadow 0.16s;
  }
  #propsbar {
    overflow-y: auto;
    max-height: calc(100vh - 60px);
  }
  .sticker-panel,
  .draw-panel,
  .ai-panel {
    max-width: 900px;
    margin: 10px auto 10px auto;
  }
  .sticker-panel {
    background: rgba(241, 250, 247, 0.82);
    border: 1.5px solid #cdf8ea;
    border-radius: 11px;
    padding: 9px 6px 9px 12px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: center;
  }
  .sticker-choice {
    display: inline-block;
    font-size: 2.1em;
    cursor: pointer;
    border-radius: 7px;
    padding: 3px 8px 1px 8px;
    border: 2px solid transparent;
    transition: background 0.14s;
    user-select: none;
  }
  .sticker-choice.selected,
  .sticker-choice:hover {
    background: #e7fbf7;
    border-color: #82ead7;
  }
  .draw-panel {
    background: rgba(250, 246, 224, 0.73);
    border: 1.5px solid #eedc9b;
    border-radius: 10px;
    padding: 8px 12px 6px 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .draw-options {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  .draw-brush-demo {
    width: 41px;
    height: 27px;
    display: inline-block;
    vertical-align: middle;
  }
  .draw-brush-demo canvas {
    border-radius: 5px;
  }
  .draw-btn {
    padding: 6px 12px;
    background: #f4d23a;
    border: none;
    border-radius: 7px;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  .draw-btn:hover {
    background: #d4bb17;
  }
  .draw-btn.active {
    background: #d4ac0d;
    color: #fff;
  }
  @media (max-width: 1020px) {
    #studio-shell {
      max-width: 100vw;
      border-radius: 0;
      padding: 0;
      height: auto;
    }
    #main-canvas {
      max-width: 100vw;
    }
    #sidebar,
    #propsbar {
      position: fixed;
      z-index: 110;
    }
    #sidebar {
      left: -120px;
      width: 68px;
    }
    #sidebar.show {
      left: 0;
    }
    #propsbar {
      right: -360px;
      min-width: 180px;
    }
    #propsbar.show {
      right: 0;
    }
    #propsbar {
      max-height: 100vh;
    }
  }
</style>
</head>
<body>
  <div id="topAdContainer">
    <ins
      class="adsbygoogle"
      style="display:block"
      data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
      data-ad-slot="YYYYYYYYYY"
      data-ad-format="auto"
      data-full-width-responsive="true"
    ></ins>
  </div>
  <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>

  <div id="appbar">
    <span class="logo"
      ><i class="fa-solid fa-layer-group"></i> Studio Creator</span
    >
    <nav>
      <button id="undoBtn" title="Undo (Ctrl+Z)">
        <i class="fa-solid fa-rotate-left"></i>
      </button>
      <button id="redoBtn" title="Redo (Ctrl+Y)">
        <i class="fa-solid fa-rotate-right"></i>
      </button>
      <button id="saveBtn" title="Save Design">
        <i class="fa-solid fa-floppy-disk"></i>
      </button>
      <button id="exportBtn" title="Export PNG">
        <i class="fa-solid fa-download"></i>
      </button>
      <button id="themeBtn" title="Toggle Dark/Light Theme">
        <i class="fa-solid fa-circle-half-stroke"></i>
      </button>
    </nav>
  </div>
  <div id="studio-shell" role="main">
    <div
      id="sidebar"
      tabindex="0"
      role="complementary"
      aria-label="Toolbar sidebar"
    >
      <button
        class="sidebtn selected"
        id="toolImages"
        title="BG & AI"
      >
        <i class="fa-solid fa-image"></i>
        <div class="tool-tip">BG & AI</div>
      </button>
      <button class="sidebtn" id="toolText" title="Text">
        <i class="fa-solid fa-font"></i>
        <div class="tool-tip">Text</div>
      </button>
      <button class="sidebtn" id="toolStickers" title="Stickers">
        <i class="fa-solid fa-face-smile-beam"></i>
        <div class="tool-tip">Stickers</div>
      </button>
      <button class="sidebtn" id="toolDraw" title="Draw">
        <i class="fa-solid fa-pen"></i>
        <div class="tool-tip">Draw</div>
      </button>
      <button class="sidebtn" id="toolLayers" title="Layers">
        <i class="fa-solid fa-layer-group"></i>
        <div class="tool-tip">Layers</div>
      </button>
    </div>
    <div id="middle-panel">
      <div id="canvasbar" role="region" aria-label="Canvas controls">
        <span class="title" id="canvasTitle">
          YouTube Thumbnail — <span style="color: #37e2b3; font-weight: 900"
            >1280×720</span
          >
        </span>
        <div>
          <button
            class="tbar-btn"
            id="toggleGridBtn"
            aria-pressed="false"
            aria-label="Toggle grid overlay"
          >
            <i class="fa-solid fa-grip-lines"></i>
          </button>
          <button
            class="tbar-btn"
            id="zoomInBtn"
            aria-label="Zoom in"
          >
            <i class="fa-solid fa-magnifying-glass-plus"></i>
          </button>
          <button
            class="tbar-btn"
            id="zoomOutBtn"
            aria-label="Zoom out"
          >
            <i class="fa-solid fa-magnifying-glass-minus"></i>
          </button>
        </div>
      </div>

      <div
        id="ai-panel"
        class="ai-panel"
        role="region"
        aria-label="AI Image Generator"
        hidden
      >
        <strong>AI-Assisted Image Generator</strong>
        <small>Describe any scene & generate a background image</small>
        <div class="ai-controls">
          <input
            id="aiPrompt"
            type="text"
            maxlength="120"
            aria-label="AI Image description"
            placeholder="e.g. futuristic city at sunset"
            autocomplete="off"
          />
          <button
            id="aiGenBtn"
            aria-live="polite"
            aria-label="Generate AI image"
          >
            Generate
          </button>
        </div>
        <div class="ai-status" id="aiStatus" aria-live="polite" role="status"></div>
        <div class="ai-img-preview" id="aiImgPrev" style="display: none">
          <img id="aiPreviewImg" src="" alt="AI image preview" />
          <button
            id="useAiBtn"
            aria-label="Use AI generated image as background"
          >
            Use as Background
          </button>
        </div>
      </div>

      <input
        type="file"
        id="bgUpload"
        accept="image/*"
        aria-label="Upload background image"
        style="margin: 13px 0 20px 0; padding: 6px 0"
        hidden
      />

      <div
        class="sticker-panel"
        id="stickerPanel"
        tabindex="0"
        aria-label="Sticker library"
        hidden
      ></div>

      <div
        class="draw-panel"
        id="drawPanel"
        style="display: none; max-width: 900px"
      >
        <div style="margin-bottom: 7px; font-weight: 600; color: #5c5731">
          Draw mode: <span id="drawModeTxt">OFF</span>
        </div>
        <div class="draw-options">
          <label
            >Color:
            <input
              type="color"
              id="drawColor"
              value="#25344c"
              aria-label="Brush Color"
            />
          </label>
          <label
            >Brush size:
            <input
              type="range"
              min="2"
              max="48"
              step="1"
              id="drawSize"
              value="8"
              aria-label="Brush Size"
            />
          </label>
          <div class="draw-brush-demo" id="brushDemo"></div>
        </div>
        <button id="clearDrawBtn" class="draw-btn" aria-label="Clear all drawings">
          Clear All Drawing
        </button>
      </div>
      <canvas
        id="main-canvas"
        width="1280"
        height="720"
        style="width: 850px; height: 478px; user-select: none"
        role="img"
        aria-label="Thumbnail preview canvas"
        tabindex="0"
      ></canvas>
    </div>
    <div id="propsbar" role="region" aria-label="Properties panel">
      <div class="props-panel" id="propsPanel">
        <h3>Layer Properties</h3>
        <label for="fontSelect">Font</label>
        <select id="fontSelect" aria-describedby="fontHelp">
          <option>Impact</option>
          <option>Montserrat</option>
          <option>Arial</option>
          <option>Verdana</option>
          <option>Comic Sans MS</option>
          <option>Times New Roman</option>
        </select>
        <label for="fontSizeInput">Font Size</label>
        <input type="number" id="fontSizeInput" min="9" max="150" value="56" />
        <label for="fontColorInput">Font Color</label>
        <input type="color" id="fontColorInput" value="#132959" />
        <label><input type="checkbox" id="shadowToggle" /> Shadow</label>
        <label><input type="checkbox" id="outlineToggle" /> Outline</label>
        <label for="opacityRange">Opacity</label>
        <input
          type="range"
          id="opacityRange"
          min="0"
          max="100"
          value="100"
          class="slider"
        />
      </div>
      <div class="layer-controls">
        <span class="sidebar-label" aria-label="Layers List">Layers</span>
        <ul class="layer-list" id="layerList" tabindex="0"></ul>
        <div style="margin-top: 10px">
          <button
            class="group-btn"
            id="btnUp"
            title="Bring Forward"
            aria-label="Bring Layer Forward"
          >
            <i class="fa-solid fa-arrow-up"></i>
          </button>
          <button
            class="group-btn"
            id="btnDown"
            title="Send Backward"
            aria-label="Send Layer Backward"
          >
            <i class="fa-solid fa-arrow-down"></i>
          </button>
          <button
            class="group-btn"
            id="btnLock"
            title="Lock/Unlock"
            aria-label="Lock or Unlock Layer"
          >
            <i class="fa-solid fa-lock"></i>
          </button>
          <button
            class="group-btn"
            id="btnDuplicate"
            title="Duplicate Layer"
            aria-label="Duplicate Layer"
          >
            <i class="fa-solid fa-copy"></i>
          </button>
          <button
            class="group-btn"
            id="btnDelete"
            title="Delete Layer"
            aria-label="Delete Layer"
          >
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
  <div id="bottomAdContainer" aria-label="Sponsored advertisement">
    <ins
      class="adsbygoogle"
      style="display: inline-block; width: 320px; height: 50px"
      data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
      data-ad-slot="ZZZZZZZZZZ"
    ></ins>
  </div>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    function checkBottomAd() {
      document.getElementById("bottomAdContainer").style.display =
        window.innerWidth < 700 ? "block" : "none";
    }
    window.addEventListener("resize", checkBottomAd);
    window.addEventListener("load", checkBottomAd);
  </script>

<script>
(() => {
  "use strict";

  // --- ELEMENTS ---
  const canvas = document.getElementById("main-canvas");
  const ctx = canvas.getContext("2d");

  const bgInput = document.getElementById("bgUpload");
  const aiPromptInput = document.getElementById("aiPrompt");
  const aiGenBtn = document.getElementById("aiGenBtn");
  const aiStatus = document.getElementById("aiStatus");
  const aiPreview = document.getElementById("aiPreviewImg");
  const aiPreviewContainer = document.getElementById("aiImgPrev");
  const aiUseBtn = document.getElementById("useAiBtn");

  const undoBtn = document.getElementById("undoBtn");
  const redoBtn = document.getElementById("redoBtn");
  const saveBtn = document.getElementById("saveBtn");
  const exportBtn = document.getElementById("exportBtn");
  const themeBtn = document.getElementById("themeBtn");

  const layerList = document.getElementById("layerList");
  const fontSelect = document.getElementById("fontSelect");
  const fontSizeInput = document.getElementById("fontSizeInput");
  const fontColorInput = document.getElementById("fontColorInput");
  const shadowToggle = document.getElementById("shadowToggle");
  const outlineToggle = document.getElementById("outlineToggle");
  const opacityRange = document.getElementById("opacityRange");

  const toggleGridBtn = document.getElementById("toggleGridBtn");
  const zoomInBtn = document.getElementById("zoomInBtn");
  const zoomOutBtn = document.getElementById("zoomOutBtn");

  const toolButtons = {
    images: document.getElementById("toolImages"),
    text: document.getElementById("toolText"),
    stickers: document.getElementById("toolStickers"),
    draw: document.getElementById("toolDraw"),
    layers: document.getElementById("toolLayers"),
  };

  const aiPanel = document.getElementById("ai-panel");
  const stickerPanel = document.getElementById("stickerPanel");
  const drawPanel = document.getElementById("drawPanel");
  const drawColorInput = document.getElementById("drawColor");
  const drawSizeInput = document.getElementById("drawSize");
  const brushDemo = document.getElementById("brushDemo");
  const clearDrawBtn = document.getElementById("clearDrawBtn");
  const drawModeTxt = document.getElementById("drawModeTxt");

  // --- STATE ---
  let bgImg = null;
  let history = [];
  let historyIndex = -1;

  let layers = [];
  let layerId = 1;
  let selectedLayerId = null;

  let showGrid = false;
  const gridSpacing = 40;
  let zoom = 1;

  let drawMode = false;
  let drawing = false;
  let drawingPath = null;

  let mouseDown = false;
  let dragPoint = null;
  let dragLayer = null;

  // --- TOOL SELECTION ---
  function selectTool(tool) {
    Object.values(toolButtons).forEach((btn) => btn.classList.remove("selected"));
    if (toolButtons[tool]) {
      toolButtons[tool].classList.add("selected");
      aiPanel.hidden = tool !== "images";
      bgInput.hidden = tool !== "images";
      stickerPanel.hidden = tool !== "stickers";
      drawPanel.style.display = tool === "draw" ? "flex" : "none";
      if (tool === "stickers") populateStickerPanel();
    } else {
      aiPanel.hidden = true;
      bgInput.hidden = true;
      stickerPanel.hidden = true;
      drawPanel.style.display = "none";
    }
  }
  selectTool("images");
  Object.entries(toolButtons).forEach(([tool, btn]) => {
    btn.addEventListener("click", () => {
      selectTool(tool);
      selectedLayerId = null;
      updatePropsPanel();
      refreshLayerList();
      draw();
    });
  });

  // --- LAYER MANAGEMENT ---
  function addLayer(layer) {
    layer.id = layerId++;
    layers.push(layer);
    selectedLayerId = layer.id;
    saveHistory();
    refreshLayerList();
    updatePropsPanel();
    draw();
  }
  function removeLayer(id) {
    layers = layers.filter((l) => l.id !== id);
    if (layers.length > 0) selectedLayerId = layers[layers.length - 1].id;
    else selectedLayerId = null;
    saveHistory();
    refreshLayerList();
    updatePropsPanel();
    draw();
  }
  function findLayerById(id) {
    return layers.find((l) => l.id === id);
  }
  function selectLayer(id) {
    if (selectedLayerId === id) return;
    selectedLayerId = id;
    updatePropsPanel();
    refreshLayerList();
    draw();
  }
  function moveLayerUp(id) {
    const idx = layers.findIndex((l) => l.id === id);
    if (idx === layers.length - 1) return;
    [layers[idx], layers[idx + 1]] = [layers[idx + 1], layers[idx]];
    saveHistory();
    refreshLayerList();
    draw();
  }
  function moveLayerDown(id) {
    const idx = layers.findIndex((l) => l.id === id);
    if (idx <= 0) return;
    [layers[idx], layers[idx - 1]] = [layers[idx - 1], layers[idx]];
    saveHistory();
    refreshLayerList();
    draw();
  }
  function toggleLockLayer(id) {
    const layer = findLayerById(id);
    if (!layer) return;
    layer.locked = !layer.locked;
    saveHistory();
    refreshLayerList();
    draw();
  }
  function duplicateLayer(id) {
    const layer = findLayerById(id);
    if (!layer) return;
    const copy = JSON.parse(JSON.stringify(layer));
    copy.id = layerId++;
    copy.x += 20;
    copy.y += 20;
    layers.push(copy);
    selectedLayerId = copy.id;
    saveHistory();
    refreshLayerList();
    updatePropsPanel();
    draw();
  }
  function truncateText(text, maxChars) {
    if (text.length <= maxChars) return text;
    return text.slice(0, maxChars - 1) + "…";
  }

  // Initial text layer
  addLayer({
    type: "text",
    content: "Double-click to edit",
    x: canvas.width / 2,
    y: 150,
    font: fontSelect.value,
    size: 56,
    color: "#ffffff",
    opacity: 1,
    shadow: false,
    outline: false,
    locked: false,
    visible: true,
  });

  // --- HISTORY MANAGEMENT ---
  function saveHistory() {
    try {
      const data = JSON.stringify({
        bgSrc: bgImg ? bgImg.src : "",
        layers,
      });
      if (history.length >= 50) history.shift();
      history = history.slice(0, historyIndex + 1);
      history.push(data);
      historyIndex = history.length - 1;
      updateUndoRedoButtons();
    } catch {}
  }
  function restoreHistory() {
    if (historyIndex < 0 || historyIndex >= history.length) return;
    const data = history[historyIndex];
    if (!data) return;
    try {
      const obj = JSON.parse(data);
      if (obj.bgSrc) {
        let bg = new Image();
        bg.onload = () => {
          bgImg = bg;
          layers = obj.layers || [];
          if (layers.length > 0) selectedLayerId = layers[layers.length - 1].id;
          else selectedLayerId = null;
          refreshLayerList();
          updatePropsPanel();
          draw();
        };
        bg.src = obj.bgSrc;
      } else {
        bgImg = null;
        layers = obj.layers || [];
        if (layers.length > 0) selectedLayerId = layers[layers.length - 1].id;
        else selectedLayerId = null;
        refreshLayerList();
        updatePropsPanel();
        draw();
      }
    } catch {}
    updateUndoRedoButtons();
  }
  function undo() {
    if (historyIndex > 0) {
      historyIndex--;
      restoreHistory();
    }
  }
  function redo() {
    if (historyIndex < history.length - 1) {
      historyIndex++;
      restoreHistory();
    }
  }
  function updateUndoRedoButtons() {
    undoBtn.disabled = historyIndex <= 0;
    redoBtn.disabled = historyIndex >= history.length - 1;
  }

  // --- UI UPDATES ---
  function refreshLayerList() {
    layerList.innerHTML = "";
    [...layers]
      .slice()
      .reverse()
      .forEach((layer) => {
        const li = document.createElement("li");
        li.dataset.id = layer.id;
        li.className = layer.id === selectedLayerId ? "selected" : "";
        let icon = "";
        switch (layer.type) {
          case "text":
            icon = '<i class="fa-solid fa-font"></i>';
            break;
          case "sticker":
            icon = '<i class="fa-solid fa-face-smile"></i>';
            break;
          case "drawing":
            icon = '<i class="fa-solid fa-pen"></i>';
            break;
          case "shape":
            icon = '<i class="fa-solid fa-square"></i>';
            break;
          default:
            icon = '<i class="fa-solid fa-layer-group"></i>';
        }
        li.innerHTML = `${icon} ${
          layer.locked ? "🔒 " : ""
        }${layer.content && layer.type === "text" ? truncateText(layer.content, 18) : layer.type}`;
        li.title = layer.content || layer.type;
        li.tabIndex = 0;
        li.addEventListener("click", () => {
          selectLayer(layer.id);
        });
        li.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            selectLayer(layer.id);
            e.preventDefault();
          }
        });
        layerList.appendChild(li);
      });
  }

  // --- CANVAS DRAWING ---
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (bgImg) {
      ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
    } else {
      ctx.fillStyle = "#beddff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    if (showGrid) drawGrid();

    layers.forEach((layer) => {
      if (layer.visible === false) return;
      ctx.save();
      ctx.globalAlpha = layer.opacity ?? 1;
      if (layer.type === "text") {
        drawTextLayer(layer);
      } else if (layer.type === "sticker") {
        drawStickerLayer(layer);
      } else if (layer.type === "drawing") {
        drawDrawingLayer(layer);
      } else if (layer.type === "shape") {
        drawShapeLayer(layer);
      }
      ctx.restore();

      if (layer.id === selectedLayerId) {
        drawSelectionBox(layer);
      }
    });
  }
  function drawGrid() {
    ctx.save();
    ctx.strokeStyle = "#60aaff66";
    ctx.lineWidth = 0.6;
    for (let x = 0; x <= canvas.width; x += gridSpacing) {
      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, canvas.height);
      ctx.stroke();
    }
    for (let y = 0; y <= canvas.height; y += gridSpacing) {
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(canvas.width, y);
      ctx.stroke();
    }
    ctx.restore();
  }
  function drawTextLayer(layer) {
    ctx.font = `bold ${layer.size}px ${layer.font}`;
    ctx.textBaseline = "top";
    ctx.textAlign = "center";
    ctx.fillStyle = layer.color;
    if (layer.shadow) {
      ctx.shadowColor = "rgba(40, 40, 40, 0.8)";
      ctx.shadowBlur = Math.max(5, layer.size / 7);
      ctx.shadowOffsetX = 2;
      ctx.shadowOffsetY = 2;
    } else {
      ctx.shadowColor = "transparent";
    }
    if (layer.outline) {
      ctx.lineWidth = 3;
      ctx.strokeStyle = "black";
      ctx.strokeText(layer.content, layer.x, layer.y);
    }
    ctx.fillText(layer.content, layer.x, layer.y);
    ctx.shadowColor = "transparent";
  }
  function drawStickerLayer(layer) {
    if (!layer.imgObj) {
      const img = new Image();
      img.onload = () => {
        layer.imgObj = img;
        draw();
      };
      img.src = layer.content;
    } else {
      const size = layer.size || 150;
      ctx.drawImage(
        layer.imgObj,
        layer.x - size / 2,
        layer.y - size / 2,
        size,
        size
      );
    }
  }
  function drawShapeLayer(layer) {
    ctx.fillStyle = layer.color || "#008080";
    ctx.strokeStyle = layer.outline ? "black" : layer.color || "#008080";
    ctx.lineWidth = layer.outline ? 3 : 1;
    if (layer.shapeType === "rect") {
      ctx.fillRect(layer.x - layer.width / 2, layer.y - layer.height / 2, layer.width, layer.height);
      if (layer.outline) ctx.strokeRect(layer.x - layer.width / 2, layer.y - layer.height / 2, layer.width, layer.height);
    } else if (layer.shapeType === "circle") {
      ctx.beginPath();
      ctx.arc(layer.x, layer.y, layer.radius, 0, Math.PI * 2);
      ctx.fill();
      if (layer.outline) ctx.stroke();
    }
  }
  function drawDrawingLayer(layer) {
    ctx.strokeStyle = layer.color;
    ctx.lineWidth = layer.size;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    ctx.beginPath();
    const pts = layer.points;
    if (pts.length < 2) return;
    ctx.moveTo(pts[0][0], pts[0][1]);
    for (let i = 1; i < pts.length; i++) {
      ctx.lineTo(pts[i][0], pts[i][1]);
    }
    ctx.stroke();
  }
  function drawSelectionBox(layer) {
    ctx.save();
    ctx.strokeStyle = "#4ce3ae";
    ctx.lineWidth = 2;
    ctx.setLineDash([6, 4]);
    if (layer.type === "text") {
      ctx.font = `bold ${layer.size}px ${layer.font}`;
      const width = ctx.measureText(layer.content).width;
      const height = layer.size * 1.2;
      ctx.strokeRect(
        layer.x - width / 2 - 8,
        layer.y - 5,
        width + 16,
        height + 10
      );
    } else if (layer.type === "sticker") {
      const size = layer.size || 150;
      ctx.strokeRect(layer.x - size / 2 - 6, layer.y - size / 2 - 6, size + 12, size + 12);
    } else if (layer.type === "shape") {
      if (layer.shapeType === "rect") {
        ctx.strokeRect(layer.x - layer.width / 2 - 6, layer.y - layer.height / 2 - 6, layer.width + 12, layer.height + 12);
      } else if (layer.shapeType === "circle") {
        ctx.beginPath();
        ctx.arc(layer.x, layer.y, layer.radius + 6, 0, 2 * Math.PI);
        ctx.stroke();
      }
    }
    ctx.restore();
  }
  function getMousePos(evt) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    return {
      x: (evt.clientX - rect.left) * scaleX,
      y: (evt.clientY - rect.top) * scaleY,
    };
  }
  function isPointOnText(layer, px, py) {
    ctx.font = `bold ${layer.size}px ${layer.font}`;
    const width = ctx.measureText(layer.content).width;
    const height = layer.size * 1.2;
    return (
      px >= layer.x - width / 2 - 10 &&
      px <= layer.x + width / 2 + 10 &&
      py >= layer.y - 5 &&
      py <= layer.y + height + 5
    );
  }
  function isPointOnSticker(layer, px, py) {
    const size = layer.size || 150;
    return (
      px >= layer.x - size / 2 &&
      px <= layer.x + size / 2 &&
      py >= layer.y - size / 2 &&
      py <= layer.y + size / 2
    );
  }
  function isPointOnShape(layer, px, py) {
    if (layer.shapeType === "rect") {
      const halfW = layer.width / 2;
      const halfH = layer.height / 2;
      return px >= layer.x - halfW && px <= layer.x + halfW && py >= layer.y - halfH && py <= layer.y + halfH;
    } else if (layer.shapeType === "circle") {
      const dx = px - layer.x;
      const dy = py - layer.y;
      return (dx * dx + dy * dy) <= (layer.radius * layer.radius);
    }
    return false;
  }
  // Mouse events for dragging and drawing
  canvas.addEventListener("mousedown", (evt) => {
    if (drawMode) {
      mouseDown = true;
      drawingPath = {
        id: layerId++,
        type: "drawing",
        points: [],
        color: drawColorInput.value,
        size: parseInt(drawSizeInput.value) || 8,
        locked: false,
        visible: true,
      };
      drawingPath.points.push(Object.values(getMousePos(evt)));
      addLayer(drawingPath);
      dragLayer = drawingPath;
      dragPoint = null;
      selectedLayerId = drawingPath.id;
      updatePropsPanel();
      refreshLayerList();
      draw();
      return;
    }
    let pos = getMousePos(evt);
    for (let i = layers.length - 1; i >= 0; i--) {
      const l = layers[i];
      if (l.locked) continue;
      let hit = false;
      if (l.type === "text") hit = isPointOnText(l, pos.x, pos.y);
      else if (l.type === "sticker") hit = isPointOnSticker(l, pos.x, pos.y);
      else if (l.type === "shape") hit = isPointOnShape(l, pos.x, pos.y);
      if (hit) {
        dragLayer = l;
        dragPoint = { x: pos.x - l.x, y: pos.y - l.y };
        mouseDown = true;
        selectedLayerId = l.id;
        updatePropsPanel();
        refreshLayerList();
        draw();
        return;
      }
    }
    selectedLayerId = null;
    updatePropsPanel();
    refreshLayerList();
    draw();
  });
  canvas.addEventListener("mousemove", (evt) => {
    if (!mouseDown) return;
    if (drawMode && dragLayer && dragLayer.type === "drawing") {
      dragLayer.points.push(Object.values(getMousePos(evt)));
      draw();
      return;
    }
    if (dragLayer) {
      let pos = getMousePos(evt);
      if (dragLayer.locked) return;
      dragLayer.x = pos.x - dragPoint.x;
      dragLayer.y = pos.y - dragPoint.y;
      draw();
      return;
    }
  });
  window.addEventListener("mouseup", () => {
    mouseDown = false;
    dragLayer = null;
    dragPoint = null;
    saveHistory();
  });
  // Double-click edit for text
  canvas.addEventListener("dblclick", (evt) => {
    const pos = getMousePos(evt);
    for (let i = layers.length - 1; i >= 0; i--) {
      const layer = layers[i];
      if (layer.type === "text" && !layer.locked && isPointOnText(layer, pos.x, pos.y)) {
        const newText = prompt("Edit text:", layer.content);
        if (newText !== null && newText.trim() !== "") {
          layer.content = newText.trim();
          saveHistory();
          refreshLayerList();
          updatePropsPanel();
          draw();
        }
        break;
      }
    }
  });
  // Property panel update/apply
  function updatePropsPanel() {
    const layer = findLayerById(selectedLayerId);
    if (!layer || layer.type !== "text") {
      fontSelect.disabled = true;
      fontSizeInput.disabled = true;
      fontColorInput.disabled = true;
      shadowToggle.disabled = true;
      outlineToggle.disabled = true;
      opacityRange.disabled = true;
      return;
    }
    fontSelect.disabled = false;
    fontSizeInput.disabled = false;
    fontColorInput.disabled = false;
    shadowToggle.disabled = false;
    outlineToggle.disabled = false;
    opacityRange.disabled = false;
    fontSelect.value = layer.font;
    fontSizeInput.value = layer.size;
    fontColorInput.value = layer.color;
    shadowToggle.checked = layer.shadow;
    outlineToggle.checked = layer.outline;
    opacityRange.value = Math.round((layer.opacity ?? 1) * 100);
  }
  function applyPropsToLayer() {
    const layer = findLayerById(selectedLayerId);
    if (!layer || layer.type !== "text") return;
    layer.font = fontSelect.value;
    layer.size = Number(fontSizeInput.value) || 56;
    layer.color = fontColorInput.value;
    layer.shadow = shadowToggle.checked;
    layer.outline = outlineToggle.checked;
    layer.opacity = opacityRange.value / 100;
    draw();
    saveHistory();
  }
  fontSelect.addEventListener("change", applyPropsToLayer);
  fontSizeInput.addEventListener("input", applyPropsToLayer);
  fontColorInput.addEventListener("input", applyPropsToLayer);
  shadowToggle.addEventListener("change", applyPropsToLayer);
  outlineToggle.addEventListener("change", applyPropsToLayer);
  opacityRange.addEventListener("input", applyPropsToLayer);

  // Layer control buttons
  document.getElementById("btnUp").addEventListener("click", () => {
    if (selectedLayerId) moveLayerUp(selectedLayerId);
  });
  document.getElementById("btnDown").addEventListener("click", () => {
    if (selectedLayerId) moveLayerDown(selectedLayerId);
  });
  document.getElementById("btnLock").addEventListener("click", () => {
    if (selectedLayerId) toggleLockLayer(selectedLayerId);
  });
  document.getElementById("btnDuplicate").addEventListener("click", () => {
    if (selectedLayerId) duplicateLayer(selectedLayerId);
  });
  document.getElementById("btnDelete").addEventListener("click", () => {
    if (selectedLayerId) {
      removeLayer(selectedLayerId);
      selectedLayerId = null;
      updatePropsPanel();
    }
  });

  // Top bar buttons
  undoBtn.addEventListener("click", undo);
  redoBtn.addEventListener("click", redo);
  saveBtn.addEventListener("click", () => {
    const data = JSON.stringify({
      bgSrc: bgImg ? bgImg.src : "",
      layers,
    });
    const blob = new Blob([data], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.download = "thumbnail_design.json";
    link.href = url;
    link.click();
  });
  exportBtn.addEventListener("click", () => {
    canvas.toBlob((blob) => {
      if (blob) {
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.download = "thumbnail.png";
        link.href = url;
        link.click();
        setTimeout(() => URL.revokeObjectURL(url), 1000 * 60);
      }
    }, "image/png");
  });
  themeBtn.addEventListener("click", () => {
    document.body.classList.toggle("darktheme");
  });

  // Background upload
  bgInput.addEventListener("change", (evt) => {
    const file = evt.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        bgImg = img;
        saveHistory();
        draw();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });

  // AI Image generation (simulated)
  aiGenBtn.addEventListener("click", () => {
    const prompt = aiPromptInput.value.trim();
    if (!prompt) {
      aiStatus.textContent = "Please enter a prompt.";
      return;
    }
    aiStatus.textContent = "Generating AI image...";
    aiGenBtn.disabled = true;
    setTimeout(() => {
      const imgURL = "https://placehold.co/1280x720/png?text=" + encodeURIComponent(prompt + " (AI)");
      aiPreview.src = imgURL;
      aiPreviewContainer.style.display = "flex";
      aiStatus.textContent = "Preview ready.";
      aiGenBtn.disabled = false;
    }, 1800);
  });
  aiUseBtn.addEventListener("click", () => {
    if (!aiPreview.src) return;
    const img = new Image();
    img.onload = () => {
      bgImg = img;
      saveHistory();
      draw();
      aiStatus.textContent = "AI image set as background!";
      aiPreviewContainer.style.display = "none";
      aiPromptInput.value = "";
    };
    img.src = aiPreview.src;
  });

  // Sticker panel
  const stickerOptions = [
    "https://twemoji.maxcdn.com/v/latest/72x72/1f60a.png", // 🙂
    "https://twemoji.maxcdn.com/v/latest/72x72/1f389.png", // 🎉
    "https://twemoji.maxcdn.com/v/latest/72x72/1f525.png", // 🔥
    "https://twemoji.maxcdn.com/v/latest/72x72/1f680.png", // 🚀
    "https://twemoji.maxcdn.com/v/latest/72x72/1f44d.png", // 👍
    "https://twemoji.maxcdn.com/v/latest/72x72/2764.png",  // ❤️
    "https://twemoji.maxcdn.com/v/latest/72x72/1f3af.png", // 🎯
    "https://twemoji.maxcdn.com/v/latest/72x72/1f49a.png", // 💚
  ];
  function populateStickerPanel() {
    stickerPanel.innerHTML = "";
    stickerOptions.forEach((url) => {
      const div = document.createElement("div");
      div.className = "sticker-choice";
      div.title = "Add Sticker";
      const img = new Image();
      img.src = url;
      img.alt = "Sticker";
      img.style.width = "36px";
      img.style.height = "36px";
      img.style.pointerEvents = "none";
      div.appendChild(img);
      div.addEventListener("click", () => {
        addLayer({
          type: "sticker",
          content: url,
          x: canvas.width / 2,
          y: canvas.height / 2,
          size: 150,
          opacity: 1,
          locked: false,
          visible: true,
        });
        selectTool("layers");
      });
      stickerPanel.appendChild(div);
    });
  }

  // Draw tool brush demo
  function updateBrushDemo() {
    const w = brushDemo.clientWidth;
    const h = brushDemo.clientHeight;
    brushDemo.innerHTML = "";
    const demoCanvas = document.createElement("canvas");
    demoCanvas.width = w;
    demoCanvas.height = h;
    brushDemo.appendChild(demoCanvas);
    const dctx = demoCanvas.getContext("2d");
    dctx.clearRect(0, 0, w, h);
    dctx.strokeStyle = drawColorInput.value;
    dctx.lineWidth = drawSizeInput.value;
    dctx.lineCap = "round";
    dctx.lineJoin = "round";
    dctx.beginPath();
    dctx.moveTo(w / 4, h / 2);
    dctx.lineTo((w * 3) / 4, h / 2);
    dctx.stroke();
  }
  updateBrushDemo();
  drawColorInput.addEventListener("input", updateBrushDemo);
  drawSizeInput.addEventListener("input", updateBrushDemo);

  clearDrawBtn.addEventListener("click", () => {
    layers = layers.filter((l) => l.type !== "drawing");
    saveHistory();
    draw();
  });
  let drawActive = false;
  function toggleDrawMode() {
    drawActive = !drawActive;
    drawMode = drawActive;
    drawModeTxt.textContent = drawActive ? "ON" : "OFF";
    if (drawActive) {
      selectedLayerId = null;
      updatePropsPanel();
      refreshLayerList();
      draw();
    }
  }
  toolButtons.draw.addEventListener("click", () => {
    toggleDrawMode();
    if (drawActive) {
      selectTool("draw");
    }
  });

  // Zoom and grid
  toggleGridBtn.addEventListener("click", () => {
    showGrid = !showGrid;
    toggleGridBtn.setAttribute("aria-pressed", showGrid);
    draw();
  });
  zoomInBtn.addEventListener("click", () => {
    zoom = Math.min(zoom + 0.1, 3);
    updateCanvasZoom();
  });
  zoomOutBtn.addEventListener("click", () => {
    zoom = Math.max(zoom - 0.1, 0.4);
    updateCanvasZoom();
  });
  function updateCanvasZoom() {
    canvas.style.width = Math.round(canvas.width * zoom) + "px";
    canvas.style.height = "auto";
  }
  updateCanvasZoom();

  // Canvas drawing and drag events handled above (mousedown, mousemove, mouseup, dblclick)

  // Keyboard shortcuts Undo/Redo Ctrl+Z/Y or Cmd+Z/Y
  window.addEventListener("keydown", (e) => {
    if ((e.ctrlKey || e.metaKey) && !e.shiftKey && e.key.toLowerCase() === "z") {
      e.preventDefault();
      undo();
    } else if (
      (e.ctrlKey || e.metaKey) &&
      (e.key.toLowerCase() === "y" || (e.shiftKey && e.key.toLowerCase() === "z"))
    ) {
      e.preventDefault();
      redo();
    }
  });

  // Initialize everything on page load
  populateStickerPanel();
  saveHistory();
  updatePropsPanel();
  refreshLayerList();
  draw();
})();
</script>
  <footer style="text-align:center; margin:32px 0 8px 0; font-size:.99em;">
  <a href="privacy.html" target="_blank" rel="noopener">Privacy Policy</a>
</footer>
</body>
</html>
